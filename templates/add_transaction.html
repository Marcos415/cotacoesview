{% extends 'base.html' %}

{% block title %}Adicionar Nova Transação{% endblock %}

{% block content %}
<div class="container mx-auto p-4 max-w-lg bg-white shadow-md rounded-lg mt-8">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Adicionar Nova Transação</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="p-3 rounded-md text-sm {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'danger' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('add_transaction') }}" method="POST">
        <div class="mb-4">
            <label for="data_transacao" class="block text-gray-700 text-sm font-bold mb-2">Data da Transação:</label>
            <input type="date" name="data_transacao" id="data_transacao" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ data_transacao if data_transacao else now().strftime('%Y-%m-%d') }}" required>
        </div>
        <div class="mb-4">
            <label for="hora_transacao" class="block text-gray-700 text-sm font-bold mb-2">Hora da Transação (Opcional):</label>
            <input type="time" name="hora_transacao" id="hora_transacao" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ hora_transacao if hora_transacao else now().strftime('%H:%M') }}">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Símbolo do Ativo:</label>
            <select id="simbolo_ativo_select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Selecione um ativo existente</option>
                {% for symbol_name in symbols %}
                    <option value="{{ symbol_name }}" {% if simbolo_ativo_select and simbolo_ativo_select == symbol_name %}selected{% elif simbolo_ativo and simbolo_ativo == symbol_name %}selected{% endif %}>{{ symbol_name }} ({{ SYMBOL_MAPPING.get(symbol_name, symbol_name) }})</option>
                {% endfor %}
                <option value="OUTRO" {% if simbolo_ativo_manual %}selected{% endif %}>Outro (digitar manualmente)</option>
            </select>
            <input type="text" id="simbolo_ativo_manual" placeholder="Digite o símbolo do ativo (ex: GOOG, APPL3.SA)" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mt-2 {% if not simbolo_ativo_manual %}hidden{% endif %}" value="{{ simbolo_ativo_manual if simbolo_ativo_manual else '' }}">
            
            <!-- Campos hidden para enviar o valor correto para o Flask -->
            <input type="hidden" name="simbolo_ativo" id="final_simbolo_ativo_input">
            <input type="hidden" name="simbolo_ativo_select_hidden" id="simbolo_ativo_select_hidden" value="{{ simbolo_ativo_select }}">
            <input type="hidden" name="simbolo_ativo_manual_hidden" id="simbolo_ativo_manual_hidden" value="{{ simbolo_ativo_manual }}">
        </div>

        <div class="mb-4">
            <label for="quantidade" class="block text-gray-700 text-sm font-bold mb-2">Quantidade:</label>
            <input type="number" step="0.00000001" name="quantidade" id="quantidade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ quantidade if quantidade else '1' }}" required>
        </div>
        <div class="mb-4">
            <label for="preco_unitario" class="block text-gray-700 text-sm font-bold mb-2">Preço Unitário:</label>
            <input type="number" step="0.01" name="preco_unitario" id="preco_unitario" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ preco_unitario if preco_unitario else '' }}" required>
        </div>
        <div class="mb-4">
            <label for="tipo_operacao" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Operação:</label>
            <select name="tipo_operacao" id="tipo_operacao" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <option value="COMPRA" {% if tipo_operacao and tipo_operacao == 'COMPRA' %}selected{% endif %}>COMPRA</option>
                <option value="VENDA" {% if tipo_operacao and tipo_operacao == 'VENDA' %}selected{% endif %}>VENDA</option>
            </select>
        </div>
        <div class="mb-4">
            <label for="custos_taxas" class="block text-gray-700 text-sm font-bold mb-2">Custos/Taxas (Opcional):</label>
            <input type="number" step="0.01" name="custos_taxas" id="custos_taxas" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ custos_taxas if custos_taxas else '0.00' }}">
        </div>
        <div class="mb-6">
            <label for="observacoes" class="block text-gray-700 text-sm font-bold mb-2">Observações (Opcional):</label>
            <textarea name="observacoes" id="observacoes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">{{ observacoes if observacoes else '' }}</textarea>
        </div>
        <div class="flex items-center justify-between">
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200">
                Adicionar Transação
            </button>
            <a href="{{ url_for('index') }}" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                Voltar ao Dashboard
            </a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectElement = document.getElementById('simbolo_ativo_select');
        const manualInputElement = document.getElementById('simbolo_ativo_manual');
        const finalSimboloInput = document.getElementById('final_simbolo_ativo_input');
        const hiddenSelectValueInput = document.getElementById('simbolo_ativo_select_hidden');
        const hiddenManualValueInput = document.getElementById('simbolo_ativo_manual_hidden');

        function updateFinalSymbol() {
            if (selectElement.value === 'OUTRO') {
                finalSimboloInput.value = manualInputElement.value;
                hiddenSelectValueInput.value = 'OUTRO'; // Store 'OUTRO'
                hiddenManualValueInput.value = manualInputElement.value; // Store manual input
            } else {
                finalSimboloInput.value = selectElement.value;
                hiddenSelectValueInput.value = selectElement.value; // Store selected value
                hiddenManualValueInput.value = ''; // Clear manual input in hidden field
            }
        }

        function toggleManualInput() {
            if (selectElement.value === 'OUTRO') {
                manualInputElement.classList.remove('hidden');
                manualInputElement.setAttribute('required', 'required');
                // Ensure manual input is focused when revealed
                manualInputElement.focus();
            } else {
                manualInputElement.classList.add('hidden');
                manualInputElement.removeAttribute('required');
                manualInputElement.value = ''; // Clear manual input value when hidden
            }
            updateFinalSymbol(); // Update the final hidden input immediately
        }

        selectElement.addEventListener('change', toggleManualInput);
        manualInputElement.addEventListener('input', updateFinalSymbol); // Update on manual input change

        // Initial call to set correct state on page load (e.g., if there was a validation error and form reloaded)
        toggleManualInput();

        // Set default date to today
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        const dataTransacaoInput = document.getElementById('data_transacao');
        if (!dataTransacaoInput.value) { // Only set if not already set by Flask (e.g., after validation error)
            dataTransacaoInput.value = formattedDate;
        }

        // Set default time to current time
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');
        const formattedTime = `${hours}:${minutes}`;
        const horaTransacaoInput = document.getElementById('hora_transacao');
        if (!horaTransacaoInput.value) { // Only set if not already set by Flask
            horaTransacaoInput.value = formattedTime;
        }
    });
</script>
{% endblock %}
