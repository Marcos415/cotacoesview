{% extends 'base.html' %}

{% block title %}Minha Carteira - Gestor de Investimentos{% endblock %}

{% block head_extra %}
<!-- Plotly.js CDN (usando a versão específica 2.30.0) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<style>
    /* Estilos para o Modal (Pop-up) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
        display: flex; /* Use flexbox for centering */
        align-items: center; /* Center vertically */
        justify-content: center; /* Center horizontally */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto; /* Adjusted for flexbox centering */
        padding: 20px;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%; /* Adjust width as needed */
        max-width: 1000px; /* Max width for larger screens */
        position: relative;
    }

    .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .close-button:hover,
    .close-button:focus {
        color: #333;
        text-decoration: none;
    }

    /* Estilos para o gráfico dentro do modal */
    #modalHistoricalChart {
        min-height: 500px; /* Garante altura mínima para o gráfico */
        width: 100%;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Loader para o gráfico */
    .chart-loader {
        border-top-color: #3498db;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
        border-radius: 50%;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top-color: #3498db;
        height: 50px;
        width: 50px;
    }

    @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-gray-900 mb-8 text-center">Dashboard de Investimentos</h1>

    <!-- Cartões de Resumo da Carteira -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Cartão de Valor Total da Carteira -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white flex flex-col justify-between transform transition-transform hover:scale-105">
            <div>
                <p class="text-sm font-medium opacity-80">Valor Total da Carteira</p>
                <p class="text-3xl font-bold mt-1">R$ {{ total_valor_carteira | floatformat(2) }}</p>
            </div>
            <div class="mt-4 text-sm opacity-90">
                <p>Valor total de todos os seus ativos.</p>
            </div>
        </div>

        <!-- Cartão de Lucro/Prejuízo Total Não Realizado -->
        <div class="rounded-lg shadow-lg p-6 text-white flex flex-col justify-between 
                     {% if (total_lucro_nao_realizado + total_prejuizo_nao_realizado) >= 0 %}bg-gradient-to-r from-green-500 to-green-600{% else %}bg-gradient-to-r from-red-500 to-red-600{% endif %}
                     transform transition-transform hover:scale-105">
            <div>
                <p class="text-sm font-medium opacity-80">Lucro/Prejuízo Total (Não Realizado)</p>
                <p class="text-3xl font-bold mt-1">R$ {{ (total_lucro_nao_realizado + total_prejuizo_nao_realizado) | floatformat(2) }}</p>
            </div>
            <div class="mt-4 text-sm opacity-90">
                <p>Lucro/Prejuízo flutuante das suas posições abertas.</p>
                {# CORREÇÃO AQUI: Adiciona if para evitar divisão por zero #}
                {% set lucro_total_consolidado = total_lucro_nao_realizado + total_prejuizo_nao_realizado %}
                {% if total_valor_carteira > 0 %}
                    (Valor Percentual): {{ (lucro_total_consolidado / total_valor_carteira * 100) | floatformat(2) }}%
                {% else %}
                    (Valor Percentual): 0.00%
                {% endif %}
            </div>
        </div>

        <!-- Cartão de Número de Ativos Diferentes -->
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white flex flex-col justify-between transform transition-transform hover:scale-105">
            <div>
                <p class="text-sm font-medium opacity-80">Número de Ativos Diferentes</p>
                <p class="text-3xl font-bold mt-1">{{ posicoes|length }}</p> {# CORREÇÃO AQUI: 'posicoes' em vez de 'posicoes_carteira' #}
            </div>
            <div class="mt-4 text-sm opacity-90">
                <p>Quantidade de ativos distintos na sua carteira.</p>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="flex flex-wrap justify-center gap-4 mb-10">
        <a href="{{ url_for('add_transaction') }}"
           class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 flex items-center min-w-[220px] justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            Adicionar Nova Transação
        </a>
        <a href="{{ url_for('transactions_list') }}" {# CORREÇÃO AQUI: url_for para transactions_list #}
           class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 flex items-center min-w-[220px] justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            Ver Todas as Transações
        </a>
    </div>

    <!-- Lista de Investimentos Atuais -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Meus Investimentos Atuais</h2>
        <!-- Wrapper para rolagem vertical (~5-6 itens visíveis) -->
        <div class="overflow-y-auto max-h-[280px] border border-gray-200 rounded-lg"> {# Ajustado max-h aqui #}
            <div class="overflow-x-auto"> {# Permite rolagem horizontal APENAS dentro desta div se a tabela for muito larga #}
                {% if posicoes %} {# CORREÇÃO AQUI: 'posicoes' em vez de 'posicoes_carteira' #}
                <!-- Adicionando table-fixed e otimizando larguras de coluna para evitar rolagem horizontal -->
                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[18%]"> {# Ativo #}
                                Ativo
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]"> {# Quantidade #}
                                Qtd
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[12%]"> {# Preço Médio de Compra #}
                                Preço Médio
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]"> {# Preço Atual #}
                                Preço Atual
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[12%]"> {# Previsão Próximo Dia #}
                                Previsão
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[18%]"> {# Lucro/Prejuízo Não Realizado #}
                                Lucro/Prejuízo
                            </th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]"> {# Valor Total do Ativo #}
                                Valor Total
                            </th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]"> {# Gráfico #}
                                Gráfico
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for simbolo, dados in posicoes.items() %} {# CORREÇÃO AQUI: 'posicoes' em vez de 'posicoes_carteira' #}
                        <tr>
                            <td class="px-4 py-2 text-sm font-medium text-gray-900 truncate"> {# truncate para evitar overflow de texto #}
                                {{ REVERSE_SYMBOL_MAPPING.get(simbolo, simbolo) }} ({{ simbolo }}) {# Usando REVERSE_SYMBOL_MAPPING para nome amigável #}
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-500">
                                {{ dados.quantidade | floatformat(4) }} {# Usa 'quantidade' diretamente de 'dados' #}
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-500">
                                R$ {{ dados.preco_medio | floatformat(2) }}
                            </td>
                            <td class="px-4 py-2 text-sm {% if dados.preco_atual is not none and dados.preco_atual > dados.preco_medio %}text-green-600{% elif dados.preco_atual is not none and dados.preco_atual < dados.preco_medio %}text-red-600{% else %}text-gray-500{% endif %}">
                                {% if dados.preco_atual is not none %}
                                    R$ {{ dados.preco_atual | floatformat(2) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="px-4 py-2 text-sm text-blue-600">
                                {% if dados.preco_previsto is not none %}
                                    R$ {{ dados.preco_previsto | floatformat(2) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="px-4 py-2 text-sm {% if dados.lucro_prejuizo_nao_realizado is not none and dados.lucro_prejuizo_nao_realizado >= 0 %}text-green-600{% elif dados.lucro_prejuizo_nao_realizado is not none and dados.lucro_prejuizo_nao_realizado < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                                {% if dados.lucro_prejuizo_nao_realizado is not none and dados.preco_medio * dados.quantidade > 0 %}
                                    R$ {{ dados.lucro_prejuizo_nao_realizado | floatformat(2) }} ({{ ((dados.lucro_prejuizo_nao_realizado / (dados.preco_medio * dados.quantidade)) * 100) | default(0) | floatformat(2) }}%) {# CORREÇÃO AQUI: Divisão por zero #}
                                {% else %}
                                    R$ {{ dados.lucro_prejuizo_nao_realizado | floatformat(2) if dados.lucro_prejuizo_nao_realizado is not none else 'N/A' }} (0.00%)
                                {% endif %}
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-500">
                                R$ {{ dados.valor_atual | floatformat(2) }} {# Usa 'valor_atual' diretamente de 'dados' #}
                            </td>
                            <td class="px-4 py-2 text-right text-sm font-medium">
                                <button type="button" 
                                        class="show-chart-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-colors"
                                        data-symbol="{{ simbolo }}" data-asset-name="{{ REVERSE_SYMBOL_MAPPING.get(simbolo, simbolo) }}">Gráfico</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-center text-gray-500 py-4">Nenhum investimento atual na carteira. Adicione transações para vê-los aqui.</p>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Seção de Notícias Financeiras -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Notícias Financeiras Recentes</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if news_articles %} {# CORREÇÃO AQUI: 'news_articles' em vez de 'all_news' #}
                {% for article in news_articles %} {# CORREÇÃO AQUI: 'article' em vez de 'news_item' #}
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm flex flex-col justify-between transition-transform hover:scale-[1.02]">
                    <div>
                        <h3 class="font-semibold text-lg text-gray-900 mb-2 leading-tight">{{ article.title }}</h3>
                        {# Removida a linha de simbolo_display, pois não está vindo diretamente na NewsAPI #}
                        <p class="text-sm text-gray-700 mb-3">{{ article.source }} - {{ article.publishedAt | datetimeformat('%d-%m-%Y %H:%M') }}</p> {# Usa 'publishedAt' e filtro #}
                    </div>
                    <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" {# Usa 'article.url' #}
                       class="text-blue-600 hover:text-blue-800 text-sm font-medium mt-auto flex items-center">
                        Ler mais
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>
                {% endfor %}
            {% else %}
            <p class="text-center text-gray-500 py-4 col-span-full">Nenhuma notícia disponível no momento.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal do Gráfico -->
<div id="chartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h3 id="chartModalTitle" class="text-xl font-bold text-gray-800">Gráfico Histórico de Preços</h3>
            <button id="closeChartModal" class="close-button">&times;</button>
        </div>
        <!-- Modal Body -->
        <div class="p-4 flex-grow relative flex items-center justify-center">
            <div id="modalHistoricalChart" class="w-full h-full">
                <!-- Loader aparecerá aqui enquanto o gráfico carrega -->
                <div class="chart-loader mx-auto"></div> 
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Renderiza o gráfico de pizza (já existe no app.py e passa a variável correta)
        var pieChartData = {{ pie_chart_json | tojson }};
        if (pieChartData) {
            Plotly.newPlot('pieChart', pieChartData.data, pieChartData.layout);
        }

        // Renderiza o gráfico de barras (já existe no app.py e passa a variável correta)
        var barChartData = {{ bar_chart_json | tojson }};
        if (barChartData) {
            Plotly.newPlot('barChart', barChartData.data, barChartData.layout);
        }

        // --- Lógica do Modal do Gráfico Histórico ---
        const chartModal = document.getElementById('chartModal');
        const closeChartModalBtn = document.getElementById('closeChartModal');
        const modalHistoricalChart = document.getElementById('modalHistoricalChart');
        const chartModalTitle = document.getElementById('chartModalTitle');

        document.querySelectorAll('.show-chart-btn').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.dataset.symbol;
                const assetName = this.dataset.assetName;

                chartModalTitle.textContent = `Gráfico Histórico de ${assetName} (${symbol})`;
                modalHistoricalChart.innerHTML = '<div class="chart-loader mx-auto"></div>'; // Mostra o loader
                chartModal.classList.remove('hidden'); // Exibe o modal

                // Fetch data for historical chart
                fetch(`/get_historical_chart_data/${symbol}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        modalHistoricalChart.innerHTML = ''; // Limpa o loader
                        if (data.plot_json) {
                            var plotData = JSON.parse(data.plot_json);
                            Plotly.newPlot('modalHistoricalChart', plotData.data, plotData.layout);
                        } else {
                            modalHistoricalChart.innerHTML = '<p class="text-center text-gray-500">Não foi possível carregar dados históricos para este ativo.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar dados do gráfico histórico:', error);
                        modalHistoricalChart.innerHTML = `<p class="text-center text-red-500">Erro ao carregar o gráfico: ${error.message}.</p>`;
                    });
            });
        });

        closeChartModalBtn.addEventListener('click', function() {
            chartModal.classList.add('hidden'); // Esconde o modal
            modalHistoricalChart.innerHTML = ''; // Limpa o conteúdo do gráfico
        });

        // Fecha o modal se clicar fora do conteúdo
        chartModal.addEventListener('click', function(event) {
            if (event.target === chartModal) {
                chartModal.classList.add('hidden');
                modalHistoricalChart.innerHTML = '';
            }
        });
    });
</script>
{% endblock %}
