{% extends 'base.html' %}

{% block title %}Dashboard - Minha Carteira{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Bem-vindo, {{ user_name }}!</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="p-3 rounded-md text-sm {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'danger' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Valor Total da Carteira</p>
                <p class="text-2xl font-bold text-gray-900">R$ {{ total_valor_carteira|floatformat(2) }}</p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Lucro Não Realizado</p>
                <p class="text-2xl font-bold {% if total_lucro_nao_realizado >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    R$ {{ total_lucro_nao_realizado|floatformat(2) }}
                </p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 3m-4 6L2 14" />
            </svg>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Prejuízo Não Realizado</p>
                <p class="text-2xl font-bold {% if total_prejuizo_nao_realizado <= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    R$ {{ total_prejuizo_nao_realizado|floatformat(2) }}
                </p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8L11 21m-4-6L2 10" />
            </svg>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Alocação da Carteira</h3>
            {% if pie_chart_json %}
                <div id="portfolioPieChart" class="w-full h-80"></div>
                <script>
                    var graph = JSON.parse({{ pie_chart_json | tojson }});
                    Plotly.newPlot('portfolioPieChart', graph.data, graph.layout);
                </script>
            {% else %}
                <p class="text-gray-500">Nenhum dado de carteira para exibir o gráfico de alocação.</p>
            {% endif %}
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Lucro/Prejuízo Não Realizado</h3>
            {% if bar_chart_json %}
                <div id="unrealizedPLBarChart" class="w-full h-80"></div>
                <script>
                    var graph = JSON.parse({{ bar_chart_json | tojson }});
                    Plotly.newPlot('unrealizedPLBarChart', graph.data, graph.layout);
                </script>
            {% else %}
                <p class="text-gray-500">Nenhum dado para exibir o gráfico de lucro/prejuízo não realizado.</p>
            {% endif %}
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Meus Investimentos Atuais</h3>
        {% if posicoes %}
        <div class="max-h-96 overflow-y-auto"> {# <--- ADICIONADO AQUI PARA SCROLLBAR #}
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Médio</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Atual</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Previsto</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Atual</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro/Prejuízo Não Realizado</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for simbolo, dados in posicoes.items() %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ REVERSE_SYMBOL_MAPPING.get(simbolo, simbolo) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ dados.quantidade|floatformat(8) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R$ {{ dados.preco_medio|floatformat(2) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if dados.preco_atual and dados.preco_atual > dados.preco_medio %}text-green-600{% elif dados.preco_atual and dados.preco_atual < dados.preco_medio %}text-red-600{% else %}text-gray-500{% endif %}">
                            {% if dados.preco_atual is not none %}
                                R$ {{ dados.preco_atual|floatformat(2) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-500">
                            {% if dados.preco_previsto is not none %}
                                R$ {{ dados.preco_previsto|floatformat(2) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R$ {{ dados.valor_atual|floatformat(2) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if dados.lucro_prejuizo_nao_realizado >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            R$ {{ dados.lucro_prejuizo_nao_realizado|floatformat(2) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="openHistoricalChartModal('{{ simbolo }}')" class="text-indigo-600 hover:text-indigo-900 ml-4">Gráfico</button>
                            <button onclick="openAlertModal('{{ simbolo }}', '{{ dados.preco_atual|floatformat(2) if dados.preco_atual is not none else '0.00' }}')" class="text-purple-600 hover:text-purple-900 ml-4">Alerta</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div> {# <--- FIM DA DIV PARA SCROLLBAR #}
        {% else %}
        <p class="text-gray-500">Nenhum investimento atual. Adicione transações para ver sua carteira aqui.</p>
        {% endif %}
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Últimas Transações</h3>
        {% if transacoes %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Unit.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operação</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custos/Taxas</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for transacao in transacoes %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ transacao.data_transacao|datetimeformat('%Y-%m-%d') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transacao.hora_transacao|datetimeformat('%H:%M') if transacao.hora_transacao else 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ REVERSE_SYMBOL_MAPPING.get(transacao.simbolo_ativo, transacao.simbolo_ativo) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transacao.quantidade|floatformat(8) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ {{ transacao.preco_unitario|floatformat(2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm {{ 'text-green-600' if transacao.tipo_operacao == 'COMPRA' else 'text-red-600' }}">
                                {{ transacao.tipo_operacao }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ {{ transacao.custos_taxas|floatformat(2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transacao.observacoes if transacao.observacoes else 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="{{ url_for('edit_transaction', transaction_id=transacao.id) }}" class="text-indigo-600 hover:text-indigo-900">Editar</a>
                                <form action="{{ url_for('delete_transaction', transaction_id=transacao.id) }}" method="POST" class="inline ml-2" onsubmit="return confirm('Tem certeza que deseja excluir esta transação?');">
                                    <button type="submit" class="text-red-600 hover:text-red-900">Excluir</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between">
                <div>
                    Página {{ page }} de {{ total_pages }} (Total: {{ total_transacoes }} transações)
                </div>
                <div>
                    {% if page > 1 %}
                        <a href="{{ url_for('index', page=page-1, data_inicio=data_inicio, data_fim=data_fim, ordenar_por=ordenar_por, ordem=ordem, simbolo_filtro=simbolo_filtro) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Anterior</a>
                    {% endif %}
                    {% if page < total_pages %}
                        <a href="{{ url_for('index', page=page+1, data_inicio=data_inicio, data_fim=data_fim, ordenar_por=ordenar_por, ordem=ordem, simbolo_filtro=simbolo_filtro) }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Próxima</a>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <p class="text-gray-500">Nenhuma transação encontrada. Adicione uma nova transação para começar.</p>
        {% endif %}
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Alertas de Preço Ativos</h3>
        {% if alertas %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Alvo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado Em</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for alerta in alertas %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ REVERSE_SYMBOL_MAPPING.get(alerta.simbolo_ativo, alerta.simbolo_ativo) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ {{ alerta.preco_alvo|floatformat(2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ alerta.tipo_alerta }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ alerta.status }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ alerta.data_criacao|datetimeformat('%Y-%m-%d %H:%M') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <form action="{{ url_for('excluir_alerta') }}" method="POST" class="inline" onsubmit="return confirm('Tem certeza que deseja excluir este alerta?');">
                                    <input type="hidden" name="id" value="{{ alerta.id }}">
                                    <button type="submit" class="text-red-600 hover:text-red-900">Excluir</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">Nenhum alerta de preço ativo.</p>
        {% endif %}
    </div>

</div>

<!-- Modal para Gráfico Histórico -->
<div id="historicalChartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
        <h3 class="text-xl font-semibold mb-4 text-gray-800" id="historicalChartTitle">Gráfico Histórico</h3>
        <button onclick="closeHistoricalChartModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
        <div id="historicalChartContainer" class="w-full h-96"></div>
        <div id="historicalChartLoading" class="hidden text-center text-blue-500 mt-4">Carregando gráfico...</div>
        <div id="historicalChartError" class="hidden text-center text-red-500 mt-4"></div>
    </div>
</div>

<!-- Modal para Adicionar Alerta -->
<div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Adicionar Alerta de Preço</h3>
        <button onclick="closeAlertModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
        <form action="{{ url_for('adicionar_alerta') }}" method="POST">
            <div class="mb-4">
                <label for="alert_simbolo_ativo" class="block text-gray-700 text-sm font-bold mb-2">Ativo:</label>
                <input type="text" name="simbolo_ativo" id="alert_simbolo_ativo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100" readonly required>
            </div>
            <div class="mb-4">
                <label for="preco_atual_alerta" class="block text-gray-700 text-sm font-bold mb-2">Preço Atual (aproximado):</label>
                <input type="text" id="preco_atual_alerta" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100" readonly>
            </div>
            <div class="mb-4">
                <label for="preco_alvo" class="block text-gray-700 text-sm font-bold mb-2">Preço Alvo:</label>
                <input type="number" step="0.01" name="preco_alvo" id="preco_alvo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="mb-6">
                <label for="tipo_alerta" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Alerta:</label>
                <select name="tipo_alerta" id="tipo_alerta" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="ACIMA">Acima do Preço Alvo</option>
                    <option value="ABAIXO">Abaixo do Preço Alvo</option>
                </select>
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="closeAlertModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">Cancelar</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Adicionar Alerta</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openHistoricalChartModal(simbolo) {
        const modal = document.getElementById('historicalChartModal');
        const title = document.getElementById('historicalChartTitle');
        const container = document.getElementById('historicalChartContainer');
        const loading = document.getElementById('historicalChartLoading');
        const errorDiv = document.getElementById('historicalChartError');

        title.textContent = 'Gráfico Histórico de ' + simbolo;
        container.innerHTML = ''; // Limpa qualquer gráfico anterior
        errorDiv.classList.add('hidden');
        loading.classList.remove('hidden');
        modal.classList.add('flex');
        modal.classList.remove('hidden');

        fetch(`/get_historical_chart_data/${simbolo}`)
            .then(response => {
                loading.classList.add('hidden');
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Erro desconhecido'); });
                }
                return response.json();
            })
            .then(data => {
                var graph = JSON.parse(data.plot_json);
                Plotly.newPlot('historicalChartContainer', graph.data, graph.layout);
            })
            .catch(error => {
                console.error('Erro ao buscar dados do gráfico histórico:', error);
                errorDiv.textContent = 'Erro ao carregar o gráfico: ' + error.message;
                errorDiv.classList.remove('hidden');
            });
    }

    function closeHistoricalChartModal() {
        const modal = document.getElementById('historicalChartModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function openAlertModal(simbolo, precoAtual) {
        const modal = document.getElementById('alertModal');
        document.getElementById('alert_simbolo_ativo').value = simbolo;
        document.getElementById('preco_atual_alerta').value = 'R$ ' + precoAtual;
        document.getElementById('preco_alvo').value = precoAtual; // Sugere o preço atual como alvo
        modal.classList.add('flex');
        modal.classList.remove('hidden');
    }

    function closeAlertModal() {
        const modal = document.getElementById('alertModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Fecha os modais ao clicar fora deles
    window.onclick = function(event) {
        const historicalModal = document.getElementById('historicalChartModal');
        const alertModal = document.getElementById('alertModal');
        if (event.target == historicalModal) {
            closeHistoricalChartModal();
        }
        if (event.target == alertModal) {
            closeAlertModal();
        }
    }
</script>
{% endblock %}
